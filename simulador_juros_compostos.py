import streamlit as st
import pandas as pd
import plotly.express as px
import plotly.graph_objects as go

def simulador_juros_compostos():
    st.markdown("""
    **üìà Simulador de Juros Compostos**
    
    Veja o poder do tempo e dos juros trabalhando a seu favor! Esta ferramenta mostra como pequenos aportes regulares podem se transformar em grandes patrim√¥nios ao longo do tempo.
    """)

    # Layout em duas colunas
    col1, col2 = st.columns([1, 1])
    
    with col1:
        st.markdown("### üí∞ Par√¢metros da Simula√ß√£o")
        
        valor_inicial = st.number_input(
            "üíµ Valor Inicial (R$):", 
            min_value=0.0, 
            value=1000.0, 
            step=100.0,
            help="Valor que voc√™ j√° possui para come√ßar a investir",
            key="juros_valor_inicial"
        )
        
        aporte_mensal = st.number_input(
            "üìÖ Aporte Mensal (R$):", 
            min_value=0.0, 
            value=100.0, 
            step=50.0,
            help="Valor que voc√™ pretende investir todo m√™s",
            key="juros_aporte_mensal"
        )
        
        taxa_juros_anual = st.number_input(
            "üìä Taxa de Juros Anual (%):", 
            min_value=0.0, 
            max_value=50.0,
            value=6.0, 
            step=0.5,
            help="Taxa de retorno anual esperada do investimento",
            key="juros_taxa_anual"
        )
        
        periodo_anos = st.slider(
            "‚è∞ Per√≠odo (Anos):", 
            min_value=1, 
            max_value=50, 
            value=10,
            help="Por quantos anos voc√™ pretende manter o investimento",
            key="juros_periodo_anos"
        )

        # Bot√£o de simula√ß√£o
        simular = st.button("üöÄ Simular Crescimento", key="simular_juros_compostos_btn", type="primary")

    with col2:
        st.markdown("### üìã Cen√°rios de Compara√ß√£o")
        
        # Op√ß√µes de cen√°rios pr√©-definidos
        cenario_selecionado = st.selectbox(
            "Escolha um cen√°rio para comparar:",
            ["Personalizado", "Conservador (4% a.a.)", "Moderado (8% a.a.)", "Arrojado (12% a.a.)"],
            key="cenario_comparacao"
        )
        
        # Informa√ß√µes educativas
        st.info("""
        **üí° Dica Importante:**
        
        Os juros compostos s√£o chamados de "oitava maravilha do mundo" por Einstein. 
        O segredo est√° na **consist√™ncia** e no **tempo**!
        
        - üéØ **Consist√™ncia:** Aportes regulares, mesmo pequenos
        - ‚è≥ **Tempo:** Quanto mais cedo come√ßar, melhor
        - üìà **Paci√™ncia:** Deixe os juros trabalharem para voc√™
        """)

    # √Årea de resultados (ser√° preenchida quando o bot√£o for clicado)
    if simular:
        st.markdown("---")
        st.subheader("üìä Resultados da Simula√ß√£o")
        
        # C√°lculos dos juros compostos
        taxa_mensal = taxa_juros_anual / 100 / 12  # Converte para taxa mensal decimal
        meses_total = periodo_anos * 12
        
        # Listas para armazenar os dados da simula√ß√£o
        meses = []
        valores_acumulados = []
        aportes_totais = []
        juros_acumulados = []
        
        valor_atual = valor_inicial
        aporte_total = valor_inicial
        
        for mes in range(meses_total + 1):
            meses.append(mes)
            valores_acumulados.append(valor_atual)
            aportes_totais.append(aporte_total)
            juros_acumulados.append(valor_atual - aporte_total)
            
            # Aplica juros e adiciona aporte (exceto no √∫ltimo m√™s)
            if mes < meses_total:
                valor_atual = valor_atual * (1 + taxa_mensal) + aporte_mensal
                aporte_total += aporte_mensal
        
        # Valores finais
        valor_final = valores_acumulados[-1]
        total_aportes = aportes_totais[-1]
        total_juros = juros_acumulados[-1]
        
        # C√°lculo do cen√°rio de compara√ß√£o
        cenarios_taxa = {
            "Conservador (4% a.a.)": 4.0,
            "Moderado (8% a.a.)": 8.0,
            "Arrojado (12% a.a.)": 12.0
        }
        
        if cenario_selecionado != "Personalizado":
            taxa_comparacao = cenarios_taxa[cenario_selecionado] / 100 / 12
            valor_comparacao = valor_inicial
            aporte_total_comp = valor_inicial
            
            for mes in range(meses_total):
                valor_comparacao = valor_comparacao * (1 + taxa_comparacao) + aporte_mensal
                aporte_total_comp += aporte_mensal
        
        # Cria√ß√£o do DataFrame para o gr√°fico
        df_simulacao = pd.DataFrame({
            'M√™s': meses,
            'Valor Acumulado': valores_acumulados,
            'Aportes Totais': aportes_totais,
            'Juros Acumulados': juros_acumulados
        })
        
        # Convertendo meses para anos para melhor visualiza√ß√£o
        df_simulacao['Ano'] = df_simulacao['M√™s'] / 12
        
        # Gr√°fico interativo
        st.markdown("### üìà Evolu√ß√£o do Patrim√¥nio")
        
        fig = go.Figure()
        
        # Linha do valor total acumulado
        fig.add_trace(go.Scatter(
            x=df_simulacao['Ano'],
            y=df_simulacao['Valor Acumulado'],
            mode='lines',
            name='Valor Total',
            line=dict(color='#1f77b4', width=3),
            hovertemplate='<b>Ano %{x:.1f}</b><br>Valor Total: R$ %{y:,.2f}<extra></extra>'
        ))
        
        # Linha dos aportes totais
        fig.add_trace(go.Scatter(
            x=df_simulacao['Ano'],
            y=df_simulacao['Aportes Totais'],
            mode='lines',
            name='Aportes Totais',
            line=dict(color='#ff7f0e', width=2),
            hovertemplate='<b>Ano %{x:.1f}</b><br>Aportes: R$ %{y:,.2f}<extra></extra>'
        ))
        
        # Linha dos juros acumulados
        fig.add_trace(go.Scatter(
            x=df_simulacao['Ano'],
            y=df_simulacao['Juros Acumulados'],
            mode='lines',
            name='Juros Acumulados',
            line=dict(color='#2ca02c', width=2),
            fill='tonexty',
            hovertemplate='<b>Ano %{x:.1f}</b><br>Juros: R$ %{y:,.2f}<extra></extra>'
        ))
        
        # Linha de compara√ß√£o (se aplic√°vel)
        if cenario_selecionado != "Personalizado":
            anos_comparacao = [i/12 for i in range(meses_total + 1)]
            valores_comparacao = []
            valor_comp_atual = valor_inicial
            aporte_comp_total = valor_inicial
            
            for mes in range(meses_total + 1):
                valores_comparacao.append(valor_comp_atual)
                if mes < meses_total:
                    valor_comp_atual = valor_comp_atual * (1 + taxa_comparacao) + aporte_mensal
            
            fig.add_trace(go.Scatter(
                x=anos_comparacao,
                y=valores_comparacao,
                mode='lines',
                name=f'Cen√°rio {cenario_selecionado}',
                line=dict(color='#d62728', width=2, dash='dash'),
                hovertemplate=f'<b>Ano %{{x:.1f}}</b><br>{cenario_selecionado}: R$ %{{y:,.2f}}<extra></extra>'
            ))
        
        fig.update_layout(
            title='Evolu√ß√£o do Patrim√¥nio ao Longo do Tempo',
            xaxis_title='Anos',
            yaxis_title='Valor (R$)',
            hovermode='x unified',
            height=500,
            showlegend=True
        )
        
        # Formata√ß√£o do eixo Y para valores em reais
        fig.update_layout(yaxis=dict(tickformat=',.0f'))
        
        st.plotly_chart(fig, use_container_width=True)
        
        # Resumo financeiro
        st.markdown("### üí∞ Resumo Financeiro")
        
        col1, col2, col3 = st.columns(3)
        
        with col1:
            st.metric(
                label="üíµ Valor Final",
                value=f"R$ {valor_final:,.2f}",
                delta=f"R$ {total_juros:,.2f} em juros"
            )
        
        with col2:
            st.metric(
                label="üìä Total Investido",
                value=f"R$ {total_aportes:,.2f}",
                delta=f"{periodo_anos} anos de aportes"
            )
        
        with col3:
            rentabilidade = ((valor_final / total_aportes) - 1) * 100
            st.metric(
                label="üìà Rentabilidade Total",
                value=f"{rentabilidade:.1f}%",
                delta=f"{taxa_juros_anual:.1f}% ao ano"
            )
        
        # Tabela detalhada (apenas anos principais)
        st.markdown("### üìã Evolu√ß√£o Detalhada (Por Ano)")
        
        # Filtra dados apenas para o final de cada ano
        df_anual = df_simulacao[df_simulacao['M√™s'] % 12 == 0].copy()
        df_anual['Ano'] = df_anual['M√™s'] // 12
        df_anual = df_anual[['Ano', 'Valor Acumulado', 'Aportes Totais', 'Juros Acumulados']]
        
        # Formata√ß√£o da tabela
        df_anual['Valor Acumulado'] = df_anual['Valor Acumulado'].apply(lambda x: f"R$ {x:,.2f}")
        df_anual['Aportes Totais'] = df_anual['Aportes Totais'].apply(lambda x: f"R$ {x:,.2f}")
        df_anual['Juros Acumulados'] = df_anual['Juros Acumulados'].apply(lambda x: f"R$ {x:,.2f}")
        
        st.dataframe(df_anual, use_container_width=True, hide_index=True)
        
        # An√°lise e insights
        st.markdown("### üéØ An√°lise e Insights")
        
        # C√°lculo de insights
        participacao_juros = (total_juros / valor_final) * 100
        valor_sem_juros = total_aportes
        multiplicador = valor_final / total_aportes
        
        col1, col2 = st.columns(2)
        
        with col1:
            st.info(f"""
            **üîç An√°lise do Seu Investimento:**
            
            ‚Ä¢ **Participa√ß√£o dos Juros:** {participacao_juros:.1f}% do valor final
            ‚Ä¢ **Multiplicador:** Seu dinheiro cresceu {multiplicador:.1f}x
            ‚Ä¢ **Poder dos Juros:** R$ {total_juros:,.2f} "de gra√ßa"
            """)
        
        with col2:
            if participacao_juros > 50:
                st.success(f"""
                **üéâ Excelente Estrat√©gia!**
                
                Os juros representam mais da metade do seu patrim√¥nio final. 
                Isso mostra o poder dos juros compostos trabalhando a seu favor!
                """)
            elif participacao_juros > 30:
                st.warning(f"""
                **üëç Boa Estrat√©gia!**
                
                Os juros j√° representam uma parte significativa do patrim√¥nio. 
                Considere aumentar o per√≠odo ou a taxa para potencializar ainda mais.
                """)
            else:
                st.error(f"""
                **üí° Dica de Melhoria:**
                
                Os juros ainda representam uma pequena parte. 
                Considere aumentar o per√≠odo de investimento ou buscar melhores taxas.
                """)
        
        # Compara√ß√£o com cen√°rio (se aplic√°vel)
        if cenario_selecionado != "Personalizado":
            diferenca = valor_final - valor_comparacao
            if diferenca > 0:
                st.success(f"""
                **üìä Compara√ß√£o com {cenario_selecionado}:**
                
                Sua estrat√©gia atual resultaria em **R$ {diferenca:,.2f} a mais** 
                comparado ao cen√°rio {cenario_selecionado.lower()}.
                """)
            else:
                st.warning(f"""
                **üìä Compara√ß√£o com {cenario_selecionado}:**
                
                O cen√°rio {cenario_selecionado.lower()} resultaria em **R$ {abs(diferenca):,.2f} a mais** 
                que sua estrat√©gia atual.
                """)
        
        # Dicas finais
        st.markdown("---")
        st.markdown("""
        **üí° Dicas para Maximizar seus Resultados:**
        
        1. **üéØ Consist√™ncia √© Fundamental:** Mantenha os aportes regulares, mesmo que pequenos
        2. **‚è∞ Comece Hoje:** Cada m√™s que voc√™ adia, perde o poder dos juros compostos
        3. **üìà Reinvista os Rendimentos:** Deixe os juros trabalharem para gerar mais juros
        4. **üîç Revise Periodicamente:** Ajuste a estrat√©gia conforme sua situa√ß√£o muda
        5. **üéì Continue Aprendendo:** Busque conhecimento para tomar melhores decis√µes
        """)



